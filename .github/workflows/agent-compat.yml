name: Agent Teams Compatibility

on:
  push:
    branches: [main, "feat/*", "claude/*"]
    paths:
      - ".claude/agents/**"
      - ".claude/settings.json"
      - "tests/**"
      - "pyproject.toml"
  pull_request:
    branches: [main]
  schedule:
    # Run weekly to catch new Claude Code releases
    - cron: "0 9 * * 1"
  workflow_dispatch:

jobs:
  schema-and-smoke:
    name: Schema + Smoke Tests
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install test dependencies
        run: pip install pytest pyyaml

      - name: Run schema validation
        run: pytest tests/test_agent_schema.py tests/test_team_smoke.py -v --tb=short

  contract:
    name: Contract Tests (Claude Code CLI)
    runs-on: ubuntu-latest
    needs: schema-and-smoke
    steps:
      - uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "22"

      - name: Install Claude Code CLI
        run: npm install -g @anthropic-ai/claude-code

      - name: Record Claude Code version
        run: |
          echo "Installed version:"
          claude --version
          claude --version > .claude/CLAUDE_CODE_VERSION

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install test dependencies
        run: pip install pytest pyyaml requests

      - name: Run contract tests
        run: pytest tests/test_team_contract.py -v --tb=short -m contract

  compat:
    name: Version Compatibility
    runs-on: ubuntu-latest
    needs: schema-and-smoke
    steps:
      - uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "22"

      - name: Check latest Claude Code version on npm
        run: |
          LATEST=$(npm view @anthropic-ai/claude-code version 2>/dev/null || echo "unknown")
          echo "Latest Claude Code on npm: $LATEST"
          echo "LATEST_VERSION=$LATEST" >> "$GITHUB_ENV"

      - name: Install Claude Code CLI
        run: npm install -g @anthropic-ai/claude-code

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install test dependencies
        run: pip install pytest pyyaml requests

      - name: Run compatibility tests
        run: pytest tests/test_version_compat.py -v --tb=short -m compat

      - name: Notify on version drift
        if: failure()
        run: |
          echo "::warning::Claude Code version drift detected. Latest: $LATEST_VERSION"
          echo "Update agent definitions and re-run: pytest tests/ -v"
